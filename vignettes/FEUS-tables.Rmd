---
title: "Create Tables from the Fisheries Economics of the US (FEUS) Report"
author: Emily Markowitz (Emily.Markowitz AT NOAA.gov / EmilyMarkowitz-NOAA)
date: "`r Sys.Date() `"
output: 
  html_document:
    standalone: true
    smart: true
    normalize: true
    toc: true
    highlight: tango
    self-contained: true
    theme: cerulean
  pdf_document:
    toc: true
    highlight: tango
vignette: >
  %\VignetteIndexEntry{FEUS-tables}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
# https://r-pkgs.org/vignettes.html

  # rmarkdown::html_vignette


knitr::opts_chunk$set(message = FALSE, echo = TRUE, warning = FALSE, 
  collapse = TRUE,
  comment = "#>"
)
```

# Productivity Output Analysis

Purpose: Construct the FEUS Commerical Fisheries state and national tables and output them to csv files


```{r setup}
PKG <- c(# devtools::install_github("emilymarkowitz-NOAA/FishEconProdOutput", force = TRUE)
         "FishEconProdOutput",
         
         #Seperating species by taxonomic group
         "taxize",  # install.packages("remotes"); remotes::install_github("ropensci/taxize")
         
         # Data Managment
         "tidyverse",
         "filesstrings", 
         "data.table", 
         "plyr",  
         "rlist",
         
         # #RMarkdown
         "rmarkdown",
         "ggpubr",
         "kableExtra",
         
         #Excel File Management
         "xlsx",
         "readxl"
)

for (p in PKG) {
  if(!require(p,character.only = TRUE)) {  
    install.packages(p)
    require(p,character.only = TRUE)}
}
```



## 1. Set your Directories where you will save everything. 

```{r}

#######DIRECTORIES############
dir.in<-getwd()
#Local Directories
dir.output<-paste0(dir.in, "/output/")
dir.create(dir.output)
dir.data<-paste0(dir.in, "/data/")
dir.out<-paste0(dir.output, Sys.Date(), "/")
dir.create(dir.out)
dir.parent<-dirname(dir.in)

dir_outputtables<-paste0(dir.out, "outputtables/")
dir.create(dir_outputtables)

date00<-paste0(Sys.Date())
```

## 2. Load example data

```{r}
###IMPORT DATA#####
counter<-0
landings_data<-FishEconProdOutput::land
kable(head(landings_data))
```


## 3. Set up folders and knowns

```{r}

# Define what regions we are interested in
reg_order = c("National", "North Pacific", "Pacific", "Western Pacific (Hawai`i)", 
              "New England", 
              "Mid-Atlantic", "South Atlantic", "Gulf of Mexico")

reg_order_abbrv = c("US", "NP", "Pac", "WP", "NE", "MA", "SA", "GOM")

# Create Lists (in FEUS this makes more sense)
ProdOutputPI_Raw<-list()
ProdOutputPI_Print<-list()
ProdOutputQ_Raw<-list()
ProdOutputQ_Print<-list()
ProdOutputUS_Raw<-list()
ProdOutputUS_Print<-list()

# Define Category
category0 = "category"

# Define Years
maxyr<-max(landings_data$Year)
yr <- minyr <- minyr.data<-as.numeric(paste0(floor((maxyr-24)/10), 
                              ifelse(substr(maxyr, start = nchar((maxyr-24)), 
                                            stop = nchar((maxyr-24)))>=5, 6, 1))) #of data going into the analysis
minyr.ProdOut<-maxyr-19 # That will be shown in the analysis
baseyr<-as.numeric(paste0(floor(maxyr/10), 
                          ifelse(substr(maxyr, start = nchar(maxyr), 
                                        stop = nchar(maxyr))>=5, 5, 0))) #Will change every 5 years, e.g., maxyr 2019 = byr 2015; maxyr 2020 = byr 2020; maxyr 2021 = byr 2020

# Folder name for output
folder<-"T567_ProdOutput"
titleadd = paste0(minyr.ProdOut, "To", maxyr, "_FSFEUS")
counter<-0

# Define Directories
dir_analyses = paste0(dir_outputtables, folder)
dir.create(dir_analyses)

```


## 4. Run Analysis

```{r}
OutputAnalysis(landings_data = landings_data, 
               category0 = category0, 
               baseyr = baseyr, 
               titleadd = titleadd, 
               dir_analyses = dir_analyses, 
               skipplots = T, 
               reg_order = reg_order, 
               reg_order_abbrv = reg_order_abbrv)

```

## 5. Create FEUS Tables 

```{r}
place <- st <- "United States"
divideby = 1e6
print(paste0("---", place))
area = "us"
reg <- place
xreg<-0
xstate<-0
folder<-"T567_ProdOutput"
Date0 = Sys.Date()
folderpattern = "FSFEUS"

aa<-list.files(path = paste0(dir_analyses), 
               pattern = paste0(minyr.ProdOut, "To", maxyr, "_FSFEUS"), 
               full.names = TRUE)
```

### 5.1: Table 5. Regional Törnqvist Price Index, `r minyr`-`r maxyr` (`baseyr` = 1) 

```{r}

bb<-list.files(path = paste0(aa, "/outputtables/"), full.names = TRUE, pattern = "000_All")
bb<-bb[grep(pattern = gsub(pattern = "\\.", replacement = "", x = category0), x = bb)]

######******Table 5: Regional Price Index###############
webtool.T<-"commProdOutputPI"

a<-data.frame(Year = minyr.ProdOut:maxyr)
for (i in 1:length(reg_order)){
  temp<-read.xlsx(bb[grep(pattern = "_AllData", x = bb)], reg_order[i])
  temp<-temp[temp$Year %in% c(minyr.ProdOut:maxyr) &
               temp$cat %in% "Total", ]
  a0<-data.frame(temp[,names(temp) %in% "PI_CB"])
  names(a0)<-reg_order[i]
  a<-cbind.data.frame(a, a0)
}

a$Footnotes<-NA
temp.code<-a

a[,reg_order]<-round(x = a[,reg_order], digits = 2)

temp_Print <- a

ProdOutputPI_Raw<-temp.code

ProdOutputPI_Print<-temp_Print

save(ProdOutputPI_Raw, 
     file = paste0(dir_outputtables, #folder, 
                   '/ProdOutputPI_Raw.rdata'))

save(ProdOutputPI_Print, 
     file = paste0(dir_outputtables, #folder, 
                   '/ProdOutputPI_Print.rdata'))

ProdOutputPI_Print$Footnotes<-NULL
kable(ProdOutputPI_Print)

```

### 5.2: Table 6. Regional Real Landing Törnqvist Values, `r minyr.data`-`r maxyr` (`r baseyr` $ Million) 

```{r}

######******Table 6###############

a<-data.frame(Year = minyr.ProdOut:maxyr)
for (i in 1:length(reg_order)){
  temp<-read.xlsx(bb[grep(pattern = "_AllData", x = bb)], reg_order[i])
  temp<-temp[temp$Year %in% c(minyr.ProdOut:maxyr) &
               temp$cat %in% "Total", ]
  a0<-data.frame(temp[,names(temp) %in% "Q_CB"])
  names(a0)<-reg_order[i]
  a<-cbind.data.frame(a, a0)
}


a$Footnotes<-NA
temp.code<-a

a[,reg_order]<-round(x = a[,reg_order]/1e6, digits = 2)
for (i in 1:length(reg_order)){
  a[,i]<-prettyNum(x = a[,i], big.mark = ",")
}
temp_Print <- a

ProdOutputQ_Raw<-temp.code

ProdOutputQ_Print<-temp_Print

save(ProdOutputQ_Raw, 
     file = paste0(dir_outputtables, #folder, 
                   '/ProdOutputQ_Raw.rdata'))

save(ProdOutputQ_Print, 
     file = paste0(dir_outputtables, #folder, 
                   '/ProdOutputQ_Print.rdata'))

ProdOutputQ_Print$Footnotes<-NULL
kable(ProdOutputQ_Print)

```

### 5.3: Table 7. National Nominal Landing Values ($ Million), Törnqvist Price Index, (`r baseyr` = 1), and Real Landing Törnqvist Values (`r baseyr` $ Million), `r minyr.data`-`r maxyr` 

```{r}

######******Table 7###############

a<-data.frame(Year = minyr.ProdOut:maxyr)
temp<-read.xlsx(bb[grep(pattern = "_AllData", x = bb)], 
                reg_order[1])
temp<-temp[temp$Year %in% c(minyr.ProdOut:maxyr), ]
a<-data.frame(temp[,names(temp) %in% c("Year", "cat", "PI_CB", "Q_CB", "v")])

a<-dplyr::rename(a, 
                 PI = paste0("PI_CB"), 
                 Q = paste0("Q_CB"), 
                 V = "v")

# temp.code
a.pi<-spread(a[!(names(a) %in% c("V", "Q"))], cat, PI)
names(a.pi)[-1]<-paste0(names(a.pi)[-1], "_PI")
a.q<-spread(a[!(names(a) %in% c("PI", "V"))], cat, Q)
names(a.q)[-1]<-paste0(names(a.q)[-1], "_Q")
a.v<-spread(a[!(names(a) %in% c("PI", "Q"))], cat, V)
names(a.v)[-1]<-paste0(names(a.v)[-1], "_V")

b<-left_join(a.pi, a.q, by = c("Year"))
b<-left_join(b, a.v, by = c("Year"))


b<-b[,match(x = c("Year", 
                  names(b)[grep(pattern = "_V", x = names(b), ignore.case = T)], 
                  names(b)[grep(pattern = "_PI", x = names(b), ignore.case = T)], 
                  names(b)[grep(pattern = "_Q", x = names(b), ignore.case = T)]), 
            names(b))]

b<-b[,match(x = c("Year", 
                  names(b)[grep(pattern = "fin", x = names(b), ignore.case = T)], 
                  names(b)[grep(pattern = "Shell", x = names(b), ignore.case = T)], 
                  names(b)[grep(pattern = "Total", x = names(b))]), 
            names(b))]

temp.code<-b
temp.code$Footnotes<-NA


# temp_Print
b<-a
b$PI<-round(x = b$PI, digits = 2)
b$Q<-prettyNum(x = round(x = b$Q/1e6), digits = 2, big.mark = ",")
b$V<-prettyNum(x = round(x = b$V/1e6), digits = 2, big.mark = ",")


b.pi<-spread(b[!(names(b) %in% c("V", "Q"))], cat, PI)
names(b.pi)[-1]<-paste0(names(b.pi)[-1], "_PI")
b.q<-spread(b[!(names(b) %in% c("PI", "V"))], cat, Q)
names(b.q)[-1]<-paste0(names(b.q)[-1], "_Q")
b.v<-spread(b[!(names(b) %in% c("PI", "Q"))], cat, V)
names(b.v)[-1]<-paste0(names(b.v)[-1], "_V")

b<-left_join(b.pi, b.q, by = c("Year"))
b<-left_join(b, b.v, by = c("Year"))

b<-b[,match(x = c("Year", 
                  names(b)[grep(pattern = "_V", x = names(b), ignore.case = T)], 
                  names(b)[grep(pattern = "_PI", x = names(b), ignore.case = T)], 
                  names(b)[grep(pattern = "_Q", x = names(b), ignore.case = T)]), 
            names(b))]

b<-b[,match(x = c("Year", 
                  names(b)[grep(pattern = "fin", x = names(b), ignore.case = T)], 
                  names(b)[grep(pattern = "Shell", x = names(b), ignore.case = T)], 
                  names(b)[grep(pattern = "Total", x = names(b))]), 
            names(b))]

temp_Print<-b
temp_Print$Footnotes<-NA

ProdOutputUS_Raw<-temp.code

ProdOutputUS_Print<-temp_Print

save(ProdOutputUS_Raw, 
     file = paste0(dir_outputtables, '/ProdOutputUS_Raw.rdata'))

save(ProdOutputUS_Print, 
     file = paste0(dir_outputtables, '/ProdOutputUS_Print.rdata'))

ProdOutputUS_Print$Footnotes<-NULL
kable(ProdOutputUS_Print)
```

## 6. Figures

Here are a few figures that come out of this analysis!

```{r, fig.width=8}
aa<-list.files(path = paste0(dir_analyses), 
               pattern = paste0(minyr.ProdOut, "To", maxyr, "_FSFEUS"), 
               full.names = TRUE)

bb<-list.files(path = paste0(aa, "/figures/"), full.names = TRUE, pattern = "AllFiguresGrid")

load(bb)

gridfigures.list$`000_All_byr2015_categoryPI_Total`

gridfigures.list$`000_All_byr2015_categoryQ_CB_Q`

```
